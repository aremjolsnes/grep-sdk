name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      # ========================================================
      # 1. Node.js / TypeScript (npm)
      # ========================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install and Build (npm)
        run: |
          npm ci
          npm run build

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true # Don't fail if version already exists

      # ========================================================
      # 2. .NET / C# (NuGet)
      # ========================================================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build and Pack (NuGet)
        run: |
          dotnet build dotnet_sdk/GrepSdk/GrepSdk.csproj -c Release
          dotnet pack dotnet_sdk/GrepSdk/GrepSdk.csproj -c Release -o out

      - name: Publish to NuGet
        run: dotnet nuget push out/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
        continue-on-error: true

      # ========================================================
      # 3. Python (PyPI)
      # ========================================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build Python Package
        run: python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
        continue-on-error: true

      # ========================================================
      # 4. Java (Maven / GitHub Packages)
      # ========================================================
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Publish Java Package
        working-directory: java_sdk
        run: ./gradlew publish
        env:
          # Defaulting to GitHub Packages. Change build.gradle to use OSSRH for Maven Central
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # If using Maven Central:
          # OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          # OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
